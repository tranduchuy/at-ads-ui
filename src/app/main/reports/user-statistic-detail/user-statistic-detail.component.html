<div class="container">

  <div class="title1" fxLayout="row" fxLayout.xs="column" fxLayoutAlign="start start">
    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" fxLayoutGap.xs="0" fxFlex="80">
      <button mat-icon-button (click)="backToMainReport()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <p class="title2">LỊCH SỬ  NGƯỜI DÙNG CLICK QUẢNG CÁO - TÀI KHOẢN <span
          class="adsId">{{sessionService.activeAdsAccountId}}</span>
      </p>
    </div>
    <mat-form-field class="datePicker" fxFlex="20">
      <mat-label style="color: white; font-weight: bold">Khoảng thời gian thống kê</mat-label>
      <input type="text" ngxDaterangepickerMd matInput readonly [locale]="locale" [(ngModel)]="selectedDateRange"
        startKey="start" endKey="end" [material]="true" [ranges]="ranges" (datesUpdated)="onSelectDateRange($event)"
        (change)="onApplyDateRange()" ngDefaultControl />
    </mat-form-field>
  </div>

  <div class="main-inner">
    <div class="inner" *ngIf="!onLoadUserInfo">
      <div fxLayout="row" fxLayout.xs="column" fxLayoutGap="15px" class="left-detail">

        <div fxLayout="column" fxFlex="22">
          <div class="left">
            <div class="avatar">
              <ngx-avatar size="60" name="{{customerInfo.customerInfo[0].name.split(' ').slice(-1)[0]}}"
                *ngIf="customerInfo?.customerInfo.length > 0 && customerInfo?.customerInfo[0].name"></ngx-avatar>
              <ngx-avatar size="60" src="../../../../assets/icons/blank-avatar.png"
                *ngIf="!customerInfo"></ngx-avatar>
            </div>
            <div class="user-id">Người dùng<br>
              <span *ngIf="customerInfo?.customerInfo.length > 0 && customerInfo?.customerInfo[0].phoneNumber">
                {{numberWithSpaces(customerInfo?.customerInfo[0].phoneNumber, '### ### ####')}}
              </span>
              <span *ngIf="!customerInfo || !customerInfo?.customerInfo[0].phoneNumber">{{shortUuid}}</span>
            </div>
          </div>

          <div class="bottom" fxLayout="column" fxLayoutGap="17px" fxLayoutAlgin="start center">
            <mat-accordion>
              <mat-expansion-panel (opened)="detailPanelOpenState = true" (closed)="detailPanelOpenState = false"
                hideToggle *ngIf="customerInfo?.customerInfo.length > 0">
                <mat-expansion-panel-header>
                  <mat-panel-description>
                    Thông tin chi tiết
                    <mat-icon>more_horiz</mat-icon>
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <div class="panel-content">

                  <div class="panel-item" *ngFor="let item of customerInfo.customerInfo">
                    <div fxLayout="row" fxLayoutGap="10px" class="sent-info-time">
                      <div fxFlex="65">
                        <mat-divider></mat-divider>
                      </div>
                      <div fxFlex="35" class="time">
                        {{(item.createdAt | date: 'HH:mm dd/MM/yyyy') || 'Unknown'}}
                      </div>
                    </div>
                    <table class="panel-table">
                      <tbody>
                        <tr>
                          <td colspan="2">
                            <span class="user-fullname">{{item.name || 'Unknown'}}</span>
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <mat-icon>local_phone</mat-icon>
                          </td>
                          <td>{{item.phoneNumber ? numberWithSpaces(item.phoneNumber, '### ### ####') : 'Unknown'}}</td>
                        </tr>
                        <tr>
                          <td>
                            <mat-icon>email</mat-icon>
                          </td>
                          <td>{{item.email || 'Unknown'}}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                </div>
              </mat-expansion-panel>

              <mat-expansion-panel (opened)="lastAccessPanelOpenState = true"
                (closed)="lastAccessPanelOpenState = false" hideToggle *ngIf="lastHistory">
                <mat-expansion-panel-header>
                  <mat-panel-description>
                    Lần truy cập cuối
                    <mat-icon>access_time</mat-icon>
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <div class="panel-content">
                  <div class="panel-item">
                    <table class="panel-table">
                      <tbody>
                        <tr>
                          <td>Vào lúc</td>
                          <td>{{(lastHistory.createdAt | date: 'HH:mm dd/MM/yyyy') || 'Unknown'}}</td>
                        </tr>
                        <tr>
                          <td>Địa điểm</td>
                          <td>{{lastHistory.location?.city || 'Unknown'}}</td>
                        </tr>
                        <tr>
                          <td>Thiết bị</td>
                          <td>{{lastHistory.device?.vendor || 'Unknown'}}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>

        <div class="right-container" fxFlex="78">
          <div class="right">
            <mat-table
              [dataSource]="history | paginate: { itemsPerPage: pageLimit, currentPage: currentPageNumber, totalItems: totalItems }"
              class="mat-elevation-z8">

              <ng-container matColumnDef="accessTime">
                <mat-header-cell *matHeaderCellDef>Truy cập</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">

                  <mat-icon *ngIf="element.type === 2" style="color: green" class="user-action-icon"
                    matTooltip="Xem trang">
                    remove_red_eye</mat-icon>

                  <mat-icon *ngIf="element.isSpam === true && element.type === 1" style="color: crimson"
                    class="user-action-icon" matTooltip="Đã chặn và không bị tính tiền">verified_user
                  </mat-icon>

                  <mat-icon *ngIf="element.isSpam === false && element.type === 1" style="color: darkorange"
                    class="user-action-icon" matTooltip="Click chuột quảng cáo bị tính tiền">monetization_on</mat-icon>

                  {{(element.createdAt | date: 'HH:mm dd/MM/yyyy') || 'Unknown'}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="ip">
                <mat-header-cell *matHeaderCellDef>IP</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">
                  <a [routerLink]="['/bao-cao/chi-tiet-ip', element.ip, router.url]" mat-button color="accent"
                    class="ip-detail-link" matTooltip="Nhấn vào để xem chi tiết">
                    <span *ngIf="element.isSpam === true && element.type === 1"
                      style="color: crimson">{{element.ip}}</span>
                    <span *ngIf="element.isSpam === false && element.type === 1"
                      style="color: darkorange">{{element.ip}}</span>
                    <span *ngIf="element.type === 2" style="color: green">{{element.ip}}</span>
                  </a>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="action">
                <mat-header-cell *matHeaderCellDef>Hành động</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">
                  <span *ngIf="element.type === 1">Click quảng cáo</span>
                  <span *ngIf="element.type === 2">Xem trang</span>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="website">
                <mat-header-cell *matHeaderCellDef>Trang truy cập</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">
                  <a href="{{element.href}}" target="_blank">
                    {{element.pathname}}
                  </a>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="os">
                <mat-header-cell *matHeaderCellDef>Hệ điều hành</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">

                  <i *ngIf="element.os?.name === 'Windows'" class="fab fa-windows"></i>
                  <i *ngIf="element.os?.name === 'iOS'" class="fab fa-apple"></i>
                  <i *ngIf="element.os?.name === 'Android'" class="fab fa-android"></i>
                  <i *ngIf="element.os?.name === 'Mac OS'" class="fab fa-apple"></i>
                  <i *ngIf="element.os?.name === 'Linux'" class="fab fa-linux"></i>
                  <i *ngIf="element.os?.name === 'Ubuntu'" class="fab fa-ubuntu"></i>

                  {{(element.os?.name || 'Unknown') + ' ' + (element.os?.version || '')}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="browser">
                <mat-header-cell *matHeaderCellDef>Trình duyệt</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">

                  <i *ngIf="element.browser?.name === 'Edge'" class="fab fa-edge"></i>
                  <i *ngIf="element.browser?.name === 'Firefox'" class="fab fa-firefox-browser"></i>
                  <i *ngIf="element.browser?.name === 'Chrome' || element.browser?.name === 'Cốc Cốc'"
                    class="fab fa-chrome"></i>
                  <i *ngIf="element.browser?.name === 'Chromium'" class="fab fa-chrome chromium-icon"></i>
                  <i *ngIf="element.browser?.name === 'Safari' || element.browser?.name === 'Mobile Safari'"
                    class="fab fa-safari"></i>
                  <i *ngIf="element.browser?.name === 'IE'" class="fab fa-internet-explorer"></i>
                  <i *ngIf="element.browser?.name === 'Cốc Cốc'" class="fab fa-chrome"></i>
                  <i *ngIf="element.browser?.name === 'Opera'" class="fab fa-opera"></i>

                  {{(element.browser?.name || 'Unknown') + ' ' + (element.browser?.version || '')}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="isPrivateBrowsing">
                <mat-header-cell *matHeaderCellDef>Ẩn danh</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">
                  <span *ngIf="element.isPrivateBrowsing === true" style="color: darkorange; font-weight: bold">
                    <mat-icon>report_problem</mat-icon>Có
                  </span>
                  <span *ngIf="element.isPrivateBrowsing === false" style="color:silver">Không</span>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="location">
                <mat-header-cell *matHeaderCellDef>Tại (địa điểm)</mat-header-cell>
                <mat-cell *matCellDef="let element" [class.blocked-ip]="element.isSpam === true && element.type === 1"
                  [class.ads-click-ip]="element.isSpam === false && element.type === 1"
                  [class.visitor-ip]="element.type === 2">
                  {{element.location?.city || 'Unknown'}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="keyword">
                <mat-header-cell *matHeaderCellDef> Từ khóa </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.keyword || ''}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="campaignType">
                <mat-header-cell *matHeaderCellDef> Chiến dịch </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.campaignType || ''}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="matchType">
                <mat-header-cell *matHeaderCellDef> Đối sánh </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.matchType || ''}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="page">
                <mat-header-cell *matHeaderCellDef> Trang </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.page || ''}}
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="position">
                <mat-header-cell *matHeaderCellDef> Vị trí </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.position || ''}}
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="historyColumns; sticky: true"></mat-header-row>
              <mat-row *matRowDef="let row; columns: historyColumns"></mat-row>
            </mat-table>
          </div>
          <div class="pagination-wrapper">
            <div class="pagination-buttons" fxLayout="row" fxLayout.xs="column" *ngIf="pageTotal !== 1">
              <p *ngIf="pageTotal > 0">Trang <span [(ngModel)]="currentPageNumber"
                  ngDefaultControl>{{currentPageNumber === undefined ? 1 : currentPageNumber}}</span> trong tổng
                {{pageTotal}} trang</p>
              <p *ngIf="pageTotal === 0 && isProcessing === false">Chưa có ghi nhận nào.</p>
              <pagination-controls (pageChange)="changePage($event); currentPageNumber = $event" previousLabel="Trước"
                nextLabel="Sau" fxFlex fxLayoutAlign="end start" *ngIf="pageTotal > 0"></pagination-controls>
            </div>
          </div>

        </div>
      </div>


    </div>
  </div>
</div>