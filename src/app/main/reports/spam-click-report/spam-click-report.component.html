<div class="container">

  <div class="header" fxLayout="row" fxLayout.xs="column" fxLayoutAlign="start start" fxLayoutAlign.xs="center start"
    fxLayoutGap="50px" fxLayoutGap.xs="10px">
    <div class="header__text" fxFlex="55">
      BÁO CÁO CLICK QUẢNG CÁO - TÀI KHOẢN <span class="header__adsId" *ngIf="selectedAdsId">{{selectedAdsId}}</span>
    </div>

    <div class="header__no-website-notify" *ngIf="hasWebsite === false">
      Không tìm thấy website nào.
    </div>

    <mat-form-field class="header__website-selection" *ngIf="hasWebsite === true" appearance="outline">
      <mat-label>Thống kê theo</mat-label>
      <mat-select [formControl]="websiteCtrl" #singleSelect (selectionChange)="selectWebsite()"
        [disabled]="isProcessing === true">
        <mat-option>
          <ngx-mat-select-search [formControl]="websiteFilterCtrl" [placeholderLabel]="'Tìm kiếm'"
            [noEntriesFoundLabel]="'Không tìm thấy website nào'"></ngx-mat-select-search>
        </mat-option>
        <mat-option *ngFor="let website of filteredWebsites | async" [value]="website">
          {{website.name}}
        </mat-option>
      </mat-select>
      <mat-icon matPrefix class="header__icon">web</mat-icon>
    </mat-form-field>

    <mat-form-field class="header__date-picker" appearance="outline">
      <mat-label>Khoảng thời gian thống kê</mat-label>
      <input type="text" ngxDaterangepickerMd matInput readonly [locale]="locale" [(ngModel)]="selectedDateRange"
        startKey="start" endKey="end" [material]="true" [ranges]="ranges" (datesUpdated)="onSelectDateRange($event)"
        (change)="onApplyDateRange()" ngDefaultControl />
      <mat-icon matPrefix class="header__icon">access_time</mat-icon>
    </mat-form-field>

  </div>

  <div class="content">
    <p class="content__notifier">
      <span>Bạn có thể tiết kiệm trong <span class="highline1" [(ngModel)]="selectedDateRange"
          ngDefaultControl>{{selectedDateRange.end.diff(selectedDateRange.start, 'days') + 1}} ngày</span>
        từ ngày <span class="highline2" [(ngModel)]="selectedDateRange"
          ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> đến
        ngày <span class="highline2" [(ngModel)]="selectedDateRange"
          ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span> bằng việc
        hạn chế <span class="highline2">click ảo</span>.</span>
    </p>

    <div class="content__charts" fxLayout="row" fxLayout.xs="column" fxLayoutGap="10px">
      <div class="section section__pie-chart" fxFlex="25">

        <div class="section__title">
          <span>Báo cáo tổng thể click quảng cáo <br>(<span [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> - <span
              [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span>)</span>
        </div>

        <div class="section__pie-chart__div-pie-chart">
          <div class="section__pie-chart__div-pie-chart__inner">

            <ngx-charts-pie-chart *fuseIfOnDom [scheme]="pieChart.scheme" [results]="pieChart.dataSource"
              [explodeSlices]="pieChart.explodeSlices" [labels]="pieChart.labels" [trimLabels]="pieChart.trimLabels"
              [doughnut]="pieChart.doughnut" [gradient]="pieChart.gradient" (select)="pieChart.onSelect($event)"
              [labelFormatting]="pieChart.setLabelFormatting">

              <ng-template #tooltipTemplate let-model="model">
                <p style="color: #fff">
                  {{model.name.split(':')[0] + ' (' + model.value + '%)'}}
                </p>
              </ng-template>

            </ngx-charts-pie-chart>

            <div style="text-align: center" class="click-total" *ngIf="isProcessing === false">
              <span class="click-number">{{abbreviateNumber(clickTotal || 0)}}</span>
              <br><span class="click-number-text">đợt click</span>
            </div>

          </div>

        </div>

        <div class="click-detail" fxLayout="row" fxLayoutAlign="center center">
          <div class="real-click" fxFlex="50">
            <div class="number">
              <span>{{abbreviateNumber(realClickTotal)}}</span>
              <span class="percentage">{{realClickPercentage}}%</span>
            </div>
            <span class="click-number-text"></span>
            Click thật
          </div>
          <div class="spam-click" fxFlex="50">
            <div class="number">
              <span>{{abbreviateNumber(spamClickTotal)}}</span>
              <span class="percentage">{{spamClickPercentage}}%</span>
            </div>
            Click ảo
          </div>
        </div>
      </div>
      <div class="section section__line-chart" fxFlex="75">
        <div class="section__title">
          <span>Thống kê click quảng cáo mỗi ngày (<span [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> - <span
              [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span>)</span>
        </div>

        <div class="position-relative pb-16 section__line-chart__inner">
          <canvas baseChart [datasets]="lineChart.datasets.report" [labels]="lineChart.labels"
            [colors]="lineChart.colors" [options]="lineChart.options" [chartType]="lineChart.chartType"
            [options]="lineChart.chartOptions">
          </canvas>
        </div>

      </div>
    </div>

    <div class="content__charts" fxLayout="row" fxLayout.xs="column" fxLayoutGap="10px">

      <div class="section section__line-chart--2" fxFlex="33.34">
        <div class="section__title">
          <span>Tổng số click mỗi ngày (<span [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> - <span
              [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span>)</span>
        </div>

        <div class="position-relative pb-16 section__line-chart--2__inner">
          <canvas baseChart [datasets]="totalClickLineChart.datasets.report" [labels]="totalClickLineChart.labels"
            [colors]="totalClickLineChart.colors" [options]="totalClickLineChart.options"
            [chartType]="totalClickLineChart.chartType" [options]="totalClickLineChart.chartOptions">
          </canvas>
        </div>
      </div>

      <div class="section section__line-chart--2" fxFlex="33.33">
        <div class="section__title">
          <span>Số click thật mỗi ngày (<span [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> - <span
              [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span>)</span>
        </div>

        <div class="position-relative pb-16 section__line-chart--2__inner">
          <canvas baseChart [datasets]="realClickLineChart.datasets.report" [labels]="realClickLineChart.labels"
            [colors]="realClickLineChart.colors" [options]="realClickLineChart.options"
            [chartType]="realClickLineChart.chartType" [options]="realClickLineChart.chartOptions">
          </canvas>
        </div>
      </div>

      <div class="section section__line-chart--2" fxFlex="33.33">
        <div class="section__title">
          <span>Số click ảo mỗi ngày (<span [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.start | date: 'dd/MM/yyyy'}}</span> - <span
              [(ngModel)]="selectedDateRange"
              ngDefaultControl>{{selectedDateRange.end | date: 'dd/MM/yyyy'}}</span>)</span>
        </div>

        <div class="position-relative pb-16 section__line-chart--2__inner">
          <canvas baseChart [datasets]="spamClickLineChart.datasets.report" [labels]="spamClickLineChart.labels"
            [colors]="spamClickLineChart.colors" [options]="spamClickLineChart.options"
            [chartType]="spamClickLineChart.chartType" [options]="spamClickLineChart.chartOptions">
          </canvas>
        </div>
      </div>

    </div>

    <div class="content__list-ip">
      <div class="section section__list-ip">

        <div class="section__title--2">
          Danh sách IP click quảng cáo
        </div>


        <div class="section__list-ip__wrapper">
          <mat-table
            [dataSource]="advertisementClickReport | paginate: { itemsPerPage: pageLimit, currentPage: currentPageNumber, totalItems: totalItems }"
            class="mat-elevation-z8">
            <ng-container matColumnDef="time">
              <mat-header-cell *matHeaderCellDef> Thời gian </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.createdAt | date: 'HH:mm dd/MM/yyyy'}} </mat-cell>
            </ng-container>

            <ng-container matColumnDef="ip">
              <mat-header-cell *matHeaderCellDef> IP </mat-header-cell>
              <mat-cell *matCellDef="let element">

                <a matTooltip="Nhấn vào để xem chi tiết" [routerLink]="['/bao-cao/chi-tiet-ip', element.ip, router.url]"
                  class="ip-detail-link" mat-button color="accent">
                  <span *ngIf="element.isSpam === true" style="color: crimson">{{element.ip}}</span>
                  <span *ngIf="element.isSpam === false" style="color: green">{{element.ip}}</span>
                </a>

              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="click">
              <mat-header-cell style="justify-content: center" *matHeaderCellDef> Số click </mat-header-cell>
              <mat-cell *matCellDef="let element" style="justify-content: center">
                {{element.click}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef> Nhận diện </mat-header-cell>
              <mat-cell *matCellDef="let element">
                <span *ngIf="element.isSpam === true" style="color: crimson; font-weight: bold"
                  (mouseover)="showReason(element.reason || '')">
                  <mat-icon>not_interested</mat-icon> Đã chặn
                </span>
                <span *ngIf="element.isSpam === false" style="color: green; font-weight: bold"
                  (mouseover)="showReason(element.reason || '')">
                  <mat-icon>check_circle</mat-icon> Hợp lệ
                </span>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="location">
              <mat-header-cell *matHeaderCellDef> Tại (địa điểm) </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.location?.city || 'Unknown'}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="isPrivateBrowsing">
              <mat-header-cell *matHeaderCellDef> Ẩn danh </mat-header-cell>
              <mat-cell *matCellDef="let element">
                <span *ngIf="element.isPrivateBrowsing === true" style="color: darkorange; font-weight: bold">
                  <mat-icon>report_problem</mat-icon>Có
                </span>
                <span *ngIf="element.isPrivateBrowsing === false" style="color:silver">Không</span>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="keyword">
              <mat-header-cell *matHeaderCellDef> Từ khóa </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.keyword || ''}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="campaignType">
              <mat-header-cell *matHeaderCellDef> Chiến dịch </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.campaignType || ''}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="matchType">
              <mat-header-cell *matHeaderCellDef> Đối sánh </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.matchType || ''}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="page">
              <mat-header-cell *matHeaderCellDef> Trang </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.page || ''}}
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="position">
              <mat-header-cell *matHeaderCellDef> Vị trí </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{element.position || ''}}
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="advertisementClickReportColumns; sticky: true"></mat-header-row>
            <mat-row *matRowDef="let row; columns: advertisementClickReportColumns;"></mat-row>
          </mat-table>
        </div>

        <div class="section__pagination" fxLayout="row" fxLayout.xs="column" *ngIf="pageTotal !== 1">
          <div fxFlex="60">
            <p *ngIf="pageTotal > 0">Trang <span [(ngModel)]="currentPageNumber"
                ngDefaultControl>{{currentPageNumber === undefined ? 1 : currentPageNumber}}</span> trong tổng
              {{pageTotal}} trang</p>
            <p *ngIf="pageTotal === 0 && !isProcessing">Chưa có ghi nhận nào.</p>
          </div>
          <div fxFlex="10" class="item-per-page-options" *ngIf="pageTotal > 0">
            <mat-form-field>
              <mat-label>Mỗi trang</mat-label>
              <mat-select [(value)]="pageLimit" (selectionChange)="changeItemsPerPageOption($event)">
                <mat-option *ngFor="let option of itemsPerPageOptions" [value]="option.value">
                  {{option.text}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <pagination-controls (pageChange)="changePage($event); currentPageNumber = $event" previousLabel="Trước"
            nextLabel="Sau" fxFlex fxLayoutAlign="end start" *ngIf="pageTotal > 0" fxFlex="30"></pagination-controls>
        </div>

      </div>
    </div>

  </div>

</div>